<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß : ‡πÑ‡∏≠‡∏ü‡∏¥‡∏ô‡∏ô‡πå [‡πÅ‡∏ü‡∏£‡∏ô‡πÑ‡∏ä‡∏™‡πå]</title>
  <!-- External Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.7.1/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.1.2/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Queue Status Styles */
    .status-pending { background-color: #48fa92; width: 80px; text-align: center; padding: 2px 8px; border-radius: 12px; animation: blinker 1.5s infinite; }
    .status-transfer { background-color: #07daed; width: 80px; text-align: center; padding: 2px 8px; border-radius: 12px; }
    .status-done { background-color: #28a745; width: 80px; text-align: center; padding: 2px 8px; border-radius: 12px; }
    .status-editing { background-color: #fa675c; width: 80px; text-align: center; padding: 2px 8px; border-radius: 12px; animation: blinker 1.5s infinite; }
    .status-skip { background-color: #c07dfa; width: 80px; text-align: center; padding: 2px 8px; border-radius: 12px; }
    .status-available { background-color: #e2e8f0; width: 80px; text-align: center; padding: 2px 8px; border-radius: 12px; }
    /* Status Card Styles */
    .status-card { border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; margin: 8px; cursor: pointer; transition: all 0.3s; text-align: center; background-color: white; }
    .status-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .status-card.selected { border-color: #4299e1; background-color: #ebf8ff; }
    /* Queue Details Styles */
    .queue-details { font-size: 0.875rem; margin-top: 0.5rem; padding: 0.5rem; background-color: #f7fafc; border-radius: 0.375rem; max-width: 200px; overflow-wrap: break-word; }
    .queue-status-label { font-size: 0.875rem; font-weight: 600; margin-top: 0.25rem; }
    /* Animation */
    @keyframes blinker { 50% { opacity: 0.5; } }
    /* Custom SweetAlert Styles */
    .swal2-popup { font-size: 1rem !important; }
    .booking-dialog-content { margin: 1rem 0; }
    .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
    .details-input { width: 100%; margin-top: 1rem; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; }
    .queue-wrapper { display: flex; flex-direction: column; align-items: center; margin-bottom: 1rem; width: 100%; }
    .queue-status-container { display: flex; flex-direction: column; gap: 0.25rem; width: 100%; margin-top: 0.5rem; align-items: center; }
    .status-row { font-size: 0.875rem; text-align: center; }
    .details-text { font-size: 0.875rem; margin-top: 0.25rem; max-width: 200px; overflow-wrap: break-word; text-align: center; }
  </style>
</head>
<body>
  <div class="container mx-auto mt-10 p-4 bg-white rounded-lg shadow">
    <h1 class="text-center text-2xl font-bold mb-6">üí∞‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤üí∞</h1>
    <h1 class="text-center text-3xl font-bold mb-6">‚ÄºÔ∏è‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‚ÄºÔ∏è</h1>
    <div class="grid grid-cols-5 gap-4" id="queueContainer">
      <!-- Queue items will be generated here -->
    </div>
  </div>

  <script>
    // LIFF initialization
    liff.init({ liffId: '1661371622-JOE1rQ5o' })
      .catch((err) => { console.error('LIFF Initialization failed: ', err); });

    // Booking time validation
    function isBookingAllowed() {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentDate = now.getDate();
      if (currentDate < 1 || currentDate > 31) return false;
      if (currentHour === 8 && currentMinute < 30) return false;
      if (currentHour < 8) return false;
      if (currentHour > 23) return false;
      return true;
    }

    // Booking dialog function
    async function showBookingDialog() {
      return await Swal.fire({
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
        html: `
          <div class="booking-dialog-content">
            <div class="status-grid">
              <div class="status-card" data-status="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™">
                <div class="text-lg font-semibold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</div>
              </div>
              <div class="status-card" data-status="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">
                <div class="text-lg font-semibold">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
              </div>
              <div class="status-card" data-status="‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">
                <div class="text-lg font-semibold">‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
              </div>
              <div class="status-card" data-status="‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏ü">
                <div class="text-lg font-semibold">‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏ü</div>
              </div>
              <div class="status-card" data-status="‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ">
                <div class="text-lg font-semibold">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ</div>
              </div>
              <div class="status-card" data-status="‡∏Ç‡∏≠‡πÑ‡∏≠‡∏î‡∏µ">
                <div class="text-lg font-semibold">‡∏Ç‡∏≠‡πÑ‡∏≠‡∏î‡∏µ</div>
              </div>
              <div class="status-card" data-status="‡∏Ç‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                <div class="text-lg font-semibold">‡∏Ç‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
              </div>
              <div class="status-card" data-status="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                <div class="text-lg font-semibold">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
              </div>
            </div>
            <input id="selected-status" type="hidden">
            <textarea id="booking-details" class="details-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." rows="3"></textarea>
          </div>
        `,
        showCancelButton: true,
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        didOpen: () => {
          document.querySelectorAll('.status-card').forEach(card => {
            card.addEventListener('click', () => {
              document.querySelectorAll('.status-card').forEach(c => c.classList.remove('selected'));
              card.classList.add('selected');
              document.getElementById('selected-status').value = card.dataset.status;
            });
          });
        },
        preConfirm: () => {
          const status = document.getElementById('selected-status').value;
          const details = document.getElementById('booking-details').value;
          if (!status) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
            return false;
          }
          return { status, details };
        }
      });
    }

    // Main LIFF ready function
    liff.ready.then(async () => {
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      const idToken = liff.getDecodedIDToken();
      const userId = idToken.sub;
      const displayName = idToken.name;
      const pictureUrl = idToken.picture;
      const email = idToken.email;

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ form ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏á‡πÉ‡∏ô form
      $('form').append(`<input type="hidden" name="userId" value="${userId}">`);
      $('form').append(`<input type="hidden" name="displayName" value="${displayName}">`);
      $('form').append(`<input type="hidden" name="pictureUrl" value="${pictureUrl}">`);
      $('form').append(`<input type="hidden" name="email" value="${email}">`);

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏≤‡∏Å backend
      let bookedData = {};
      await $.get('https://script.google.com/macros/s/AKfycbzJUHqaO-Ga9gC21jcCW-UeEbpxD_-fAOYvmRRRQteNYmVihUhF9rd_lDCVs3UHfqXlEQ/exec', function(data) {
        bookedData = data;
      });

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß
      const queueContainer = document.getElementById('queueContainer');
      for (let i = 1; i <= 500; i++) {
        let formattedNumber = String(i);
        createQueueElement(formattedNumber, bookedData, queueContainer, userId, displayName, pictureUrl);
      }
    });

    // Create queue element function
    function createQueueElement(number, bookedData, container, userId, displayName, pictureUrl) {
      let queueWrapper = document.createElement('div');
      queueWrapper.className = "queue-wrapper";
      let queueElement = document.createElement('div');
      queueElement.className = "relative flex justify-center items-center bg-blue-500 text-white w-16 h-16 rounded-full cursor-pointer";

      if (bookedData[number] && bookedData[number].userId) {
        queueElement.innerHTML = `<img src="${bookedData[number].pictureUrl}" class="queue-image w-16 h-16 rounded-full" alt="User Profile Picture"/>`;
        let statusContainer = document.createElement('div');
        statusContainer.className = "queue-status-container";
        let statusG = document.createElement('div');
        statusG.className = "status-row";
        const gStatus = setQueueStatusLabel(bookedData[number].G || "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß");
        statusG.innerHTML = `<div class="${getStatusClass(bookedData[number].G)}">${gStatus}</div>`;
        statusContainer.appendChild(statusG);
        if (bookedData[number].userStatus) {
          let statusH = document.createElement('div');
          statusH.className = "status-row";
          statusH.textContent = bookedData[number].userStatus;
          statusContainer.appendChild(statusH);
        }
        // if (bookedData[number].userDetails) {
        //   let detailsRow = document.createElement('div');
        //   detailsRow.className = "details-text";
        //   detailsRow.textContent = bookedData[number].userDetails;
        //   statusContainer.appendChild(detailsRow);
        // }
        queueWrapper.appendChild(queueElement);
        queueWrapper.appendChild(statusContainer);
      } else {
        queueElement.innerHTML = `<span class="queue-number text-2xl">${number}</span>
                                  <img class="queue-image w-20 h-20 rounded-full hidden" alt="User Profile Picture"/>`;
        let statusElement = document.createElement('div');
        statusElement.className = "text-sm mt-2 text-black status-available";
        statusElement.textContent = "‡∏ß‡πà‡∏≤‡∏á";
        queueWrapper.appendChild(queueElement);
        queueWrapper.appendChild(statusElement);
      }
      queueElement.dataset.queue = number;
      addQueueClickHandler(queueElement, userId, displayName, pictureUrl, bookedData);
      container.appendChild(queueWrapper);
    }

    // Helper functions
    function setQueueStatusLabel(status) {
      if (status === "‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à" || status === "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || status === "‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || status === "‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || status === "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") {
        return "‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à";
      }
      const statusMap = {
        "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£": "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å...",
        "‡∏£‡∏≠‡πÇ‡∏≠‡∏ô": "‡∏£‡∏≠‡πÇ‡∏≠‡∏ô",
        "‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß": "‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß",
        "‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•": "‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...",
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢": "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢": "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
        "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ...",
        "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥": "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥"
      };
      return statusMap[status] || "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß";
    }

    function getStatusClass(status) {
      if (status === "‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à" || status === "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || status === "‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || status === "‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || status === "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") {
        return "status-done";
      }
      const classMap = {
        "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£": "status-pending",
        "‡∏£‡∏≠‡πÇ‡∏≠‡∏ô": "status-transfer",
        "‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß": "status-skip",
        "‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•": "status-editing",
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢": "status-editing",
        "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢": "status-editing",
        "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•": "status-editing",
        "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥": "status-editing"
      };
      return classMap[status] || "status-available";
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á field ‡πÉ‡∏ô Flex Message
    function createFlexField(label, value) {
      return {
        type: "box",
        layout: "horizontal",
        contents: [
          {
            type: "text",
            text: label,
            color: "#aaaaaa",
            size: "sm",
            flex: 2
          },
          {
            type: "text",
            text: value,
            wrap: true,
            color: "#666666",
            size: "sm",
            flex: 5
          }
        ],
        spacing: "lg",
        cornerRadius: "md",
        margin: "sm"
      };
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
    function formatDateTime(datetime) {
      const date = new Date(datetime || new Date());
      
      // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
      const thaiMonths = [
        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
      ];
      
      // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ ‡πÄ‡∏ß‡∏•‡∏≤"
      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®.
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      
      return `${day} ${month} ${year} ${hours}:${minutes} ‡∏ô.`;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
function createFlexMessage(queueNumber, displayName, status, details, pictureUrl) {
  const currentDate = new Date();
  
  return {
    type: "flex",
    altText: "‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à "+`‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${queueNumber}`,
    contents: {
      type: "bubble",
      body: {
        type: "box",
        layout: "vertical",
        contents: [
          {
            type: "box",
            layout: "horizontal",
            contents: [
              {
                type: "text",
                text: "‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                weight: "bold",
                size: "xl",
                color: "#8C6900", // ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                align: "center",
                margin: "md"
              }
            ],
            alignItems: "center",
            justifyContent: "center",
            paddingAll: "xs",
            backgroundColor: "#FFF59D" // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
          },
          {
            type: "box",
            layout: "horizontal",
            contents: [
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "image",
                    url: pictureUrl,
                    aspectMode: "cover",
                    size: "full"
                  }
                ],
                width: "60px",
                height: "60px",
                cornerRadius: "100px"
              },
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: displayName,
                    weight: "bold",
                    size: "md"
                  },
                  {
                    type: "text",
                    text: `‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${queueNumber}`,
                    size: "sm",
                    color: "#999999"
                  }
                ],
                margin: "md",
                spacing: "sm"
              }
            ],
            margin: "md"
          },
          {
            type: "separator",
            margin: "lg",
            color: "#E0E0E0"
          },
          {
            type: "box",
            layout: "vertical",
            margin: "lg",
            spacing: "sm",
            contents: [
              createFlexField("üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á", displayName),
              createFlexField("üî¢ ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà", queueNumber),
              createFlexField("üõ†Ô∏è ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£", status),
              createFlexField("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", details || "-"),
              createFlexField("üìÖ ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á", formatDateTime(currentDate))
            ]
          },
          {
            type: "separator",
            margin: "lg",
            color: "#E0E0E0"
          },
          {
            type: "box",
            layout: "vertical",
            margin: "lg",
            contents: [
              {
                type: "text",
                text: "‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß", // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                color: "#4285F4", // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå
                size: "sm",
                align: "center",
                style: "italic",
                decoration: "underline" // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå
              }
            ],
            action: {
              type: "uri",
              uri: "https://liff.line.me/1661371622-JOE1rQ5o" // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            }
          }
        ],
        backgroundColor: "#FFFFFF",
        paddingAll: "xl"
      },
      styles: {
        body: {
          backgroundColor: "#FFFFFF"
        }
      }
    }
  };
}
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° LINE ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô LIFF
    function sendMsgLiff(msgTemplate) {
      if (liff.isInClient()) {
        return liff.sendMessages([msgTemplate]);
      } else {
        console.warn('This function is for sending messages from within the LINE app.');
        return Promise.resolve();
      }
    }

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô queue click handler
    async function addQueueClickHandler(element, userId, displayName, pictureUrl, bookedData) {
      element.addEventListener('click', async function() {
        if (!isBookingAllowed()) {
          Swal.fire({
            title: '‚ÄºÔ∏è‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‚ÄºÔ∏è',
            html: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ<br>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 6-25 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>‡πÄ‡∏ß‡∏•‡∏≤ 08:30‡∏ô. - 17:00‡∏ô.',
            icon: 'warning'
          });
          return;
        }
        
        const queueNumber = this.dataset.queue;
        if (bookedData[queueNumber] && bookedData[queueNumber].userId) {
          Swal.fire('‚ÄºÔ∏è‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‚ÄºÔ∏è', '‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'warning');
          return;
        }
        
        let numberElement = this.querySelector('.queue-number');
        let imageElement = this.querySelector('.queue-image');
        
        const result = await showBookingDialog();
        
        if (result.value) {
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï UI ‡∏Å‡πà‡∏≠‡∏ô
          numberElement.classList.add('hidden');
          imageElement.src = pictureUrl;
          imageElement.classList.remove('hidden');
          
          const bookingData = {
            action: 'book',
            queueNumber: queueNumber,
            userId: userId,
            displayName: displayName,
            pictureUrl: pictureUrl,
            status: result.value.status,
            details: result.value.details
          };
          
          try {
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            await $.post('https://script.google.com/macros/s/AKfycbzJUHqaO-Ga9gC21jcCW-UeEbpxD_-fAOYvmRRRQteNYmVihUhF9rd_lDCVs3UHfqXlEQ/exec', bookingData);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex message
            const flexMsg = createFlexMessage(queueNumber, displayName, result.value.status, result.value.details, pictureUrl);
            
            // ‡∏™‡πà‡∏á Flex message ‡∏î‡πâ‡∏ß‡∏¢ Promise ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
            if (liff.isInClient()) {
              try {
                await sendMsgLiff(flexMsg);
                console.log('‡∏™‡πà‡∏á Flex Message ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
              } catch (msgError) {
                console.error('Error sending message:', msgError);
              }
            }
            
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏á Flex
            await Swal.fire({
              title: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              text: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
              icon: 'success',
              timer: 2000,
              timerProgressBar: true,
              showConfirmButton: false
            });
            
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Flex message ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
            if (liff.isInClient()) {
              // ‡∏£‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
              setTimeout(() => {
                liff.closeWindow();
              }, 1500);
            } else {
              window.location.reload();
            }
          } catch (error) {
            console.error('Error in booking process:', error);
            Swal.fire('‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
          }
        }
      });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
    function userAlreadyBooked(userId, bookedData) {
      for (let queue in bookedData) {
        if (bookedData[queue].userId === userId) {
          return true;
        }
      }
      return false;
    }
  </script>
</body>
</html>
