<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />

    <title>แดชบอร์ด : แฟรนไชส์</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://bit.ly/fontiton5" type="text/css" charset="utf-8" />
    <style type="text/css">
        body {
            font-family: 'line_seed_sans_th';
        }

        .rounded-full {
            border-radius: 50%;
        }

        .profile-item {
            margin-bottom: 20px;
        }

        .user-name {
            font-size: 14px;
            line-height: 1.2;
        }

        @media (max-width: 768px) {
            .grid-cols-3 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 640px) {
            .grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
        }
      
.gold, .silver, .bronze {
    position: relative;
    overflow: hidden;
}

.gold::before, .silver::before, .bronze::before,
.gold::after, .silver::after, .bronze::after {
    content: "";
    position: absolute;
    top: -50%; right: -50%; bottom: -50%; left: -50%;
    background: linear-gradient(45deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05));
    transform: skewX(-15deg);
    background-size: 200% 200%;
}

.gold::before, .silver::before, .bronze::before {
    animation: shine 3s infinite ease-in-out, moveDiagonal1 3s infinite linear;
}

.gold::after, .silver::after, .bronze::after {
    animation: shine 3s infinite ease-in-out, moveDiagonal2 3s infinite linear;
}

@keyframes shine {
  from {
    left: -100%;
  }
  to {
    left: 100%;
  }
}

@keyframes moveDiagonal1 {
    0%, 100% {
        transform: translateX(-50%) rotate(45deg);
    }
    50% {
        transform: translateX(150%) rotate(45deg);
    }
}

@keyframes moveDiagonal2 {
    0%, 100% {
        transform: translateX(150%) rotate(45deg);
    }
    50% {
        transform: translateX(-50%) rotate(45deg);
    }
}


        .gold {
            background-image: linear-gradient(145deg, #FFD700, #FFA500);
            box-shadow: 0 0 15px #FFD700, 0 0 25px #FFA500;
        }

        .silver {
            background-image: linear-gradient(145deg, #C0C0C0, #F8F8F8);
            box-shadow: 0 0 15px #C0C0C0, 0 0 25px #F8F8F8;
        }

        .bronze {
            background-image: linear-gradient(145deg, #CD7F32, #F4A460);
            box-shadow: 0 0 15px #CD7F32, 0 0 25px #F4A460;
        }
      


        .dot {
            animation: dots 1s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                color: rgba(0,0,0,0);
                text-shadow:
                    .25em 0 0 rgba(0,0,0,0),
                    .5em 0 0 rgba(0,0,0,0);
            }
            40% {
                color: black;
                text-shadow:
                    .25em 0 0 rgba(0,0,0,0),
                    .5em 0 0 rgba(0,0,0,0);
            }
            60% {
                text-shadow:
                    .25em 0 0 black,
                    .5em 0 0 rgba(0,0,0,0);
            }
            80%, 100% {
                text-shadow:
                    .25em 0 0 black,
                    .5em 0 0 black;
            }
        }
      
 /* ในส่วน <style> ของหน้า HTML */
.dashboard-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-around;
}

.dashboard-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 48%; /* กำหนดขนาดเพื่อให้มีการ์ด 2 อันต่อแถว */
  margin-bottom: 20px; /* กำหนดระยะห่างระหว่างแถว */
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  border-radius: 10px; /* กำหนดขอบเรียบร้อย */
  background-color: #ffffff; /* สีพื้นหลังของการ์ด */
}


    </style>
</head>

<body>
  
<div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
  <div class="border shadow-lg rounded-md bg-white p-4">
    <div class="flex justify-center items-center">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
      <p class="text-lg font-medium text-gray-900 ml-3">โปรดรอสักครู่<span class="dot">...</span></p>
    </div>
  </div>
</div>
  
    <div class="flex h-auto items-center justify-center bg-gray-50">
        <div class="w-full md:w-1/2 rounded-lg bg-white px-8 py-4 shadow-md m-4">
            <!-- ส่วนการ์ดอันดับ 1, 2, 3 -->
            <h3 class="text-center font-bold text-2xl font-sans mt-4">สรุป‼️ รายได้แฟรนไชส์</h3>
            <br>
            <div id="topThree" class="flex justify-around items-center mb-4">
                <!-- การ์ดจะถูกเพิ่มที่นี่โดย JavaScript -->
            </div>
            <hr>
            <h3 class="font-bold text-2xl font-sans mt-4">อันดับอื่นๆ</h3>
            <ul id="userList" class="text-center grid grid-cols-3 gap-2 mt-4">
                <!-- รายการผู้ใช้ -->
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.1/flowbite.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
         liff.init({ liffId: "1661371622-q1Yo7yZR" })
        .then(() => {
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                liff.getProfile().then(profile => {
                    const userId = profile.userId;
                    fetchData(userId);
                }).catch(err => console.error('Error getting profile:', err));
            }
        })
        .catch(err => console.error('LIFF Initialization failed', err));
    });
      
      
      function fetchData(userId) {
    showModal();
    const apiUrl = `https://script.google.com/macros/s/AKfycbwndsKLCvUBBMv7IzNqN2pzM4vky8zJPUy7h94uOixUh0CJZld3n1L5BE4hWC29uO1s/exec?q=${userId}`;
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            hideModal();
            displayDashboardCards(data);
        }).catch(error => console.error('Error fetching data:', error));
}

function displayDashboardCards(data) {
    const dashboardContainer = document.getElementById('topThree');
    dashboardContainer.className = 'dashboard-row'; // ตรวจสอบว่ามีการตั้งค่าคลาสนี้ให้กับ container
    dashboardContainer.innerHTML = ''; // ล้างการ์ดเดิม

     const cardsData = [
        { title: "ยอดขาย", value: data.sales, colorClass: "bg-blue-500" },
        { title: "รายได้สะสม", value: data.totalRevenue, colorClass: "bg-green-500" },
        { title: "รายได้ที่รอเก็บ", value: data.pendingRevenue, colorClass: "bg-yellow-500" },
        { title: "สถานะกำไร", value: data.profitStatus, colorClass: "bg-red-500" },
        { title: "ตัวแทนขาย", value: data.salesAgent, colorClass: "bg-purple-500" },
        { title: "ค่าบริการแฟรนไชส์", value: data.franchiseFee, colorClass: "bg-indigo-500" }
    ];

    cardsData.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'dashboard-card'; // ใช้คลาสที่ปรับใน CSS
        const titleElement = document.createElement('div');
        titleElement.textContent = card.title;
        const valueElement = document.createElement('div');
        valueElement.textContent = card.value;

        cardElement.appendChild(titleElement);
        cardElement.appendChild(valueElement);
        dashboardContainer.appendChild(cardElement);
    });
}


//       function fetchData(userId) {
//         showModal();
//         //const apiUrl = 'https://opensheet.elk.sh/1WeqzJEsbRc38JL7dDZOE4OQruav6Fnfd84AoHecdA6E/Agent';
//         const apiUrl = `https://script.google.com/macros/s/AKfycbxRzJmsjiPCTFABjpp1dTzHLb5HOq5r6zoobrT1nETPfYxw2Z84RYEbZaCdcmt6_35E/exec?q=${userId}`;
//         fetch(apiUrl)
//             .then(response => response.json())
//             .then(data => {
//                 hideModal();
//              const topThreeContainer = document.getElementById('topThree');
//              const userList = document.getElementById('userList');
//                     const sortedUsers = data.sort((a, b) => b.ClickFree - a.ClickFree);
//                     const topThree = sortedUsers.slice(0, 3);
//                     const otherUsers = sortedUsers.slice(3);

//                     // สร้างและแสดงการ์ดสำหรับอันดับ 1, 2, 3
//                     topThree.forEach((user, index) => {
//                         const userCard = document.createElement('div');
//                         userCard.className = 'flex flex-col items-center w-24 p-2 rounded-lg shadow text-center';
//                         // เพิ่มคลาสสำหรับสีของการ์ด
//                       userCard.classList.add("shiny");

//     switch (index) {
//         case 0:
//             userCard.classList.add("gold");
//             break;
//         case 1:
//             userCard.classList.add("silver");
//             break;
//         case 2:
//             userCard.classList.add("bronze");
//             break;
//     }
//                         const userImg = document.createElement('img');
//                         userImg.src = user.ImageUrl;
//                         userImg.onerror = function() {
//                             this.src = "https://lh3.googleusercontent.com/d/1FgWIHOrgSbRUUrOd9yycwZZavgnco9D9?key=123";
//                         };
//                         userImg.alt = 'User Image';
//                         userImg.className = 'w-16 h-16 rounded-full object-cover mb-2';
//                         const userName = document.createElement('div');
//                         userName.textContent = user.Agent;
//                         userName.className = 'text-sm font-semibold';
//                         const userScore = document.createElement('div');
//                         userScore.textContent = `${user.Score} คะแนน`;
//                         userScore.className = 'text-xs';

//                         // ถ้วยรางวัล
//                         const trophyImg = document.createElement('img');
//                         switch (index) {
//                             case 0:
//                                 trophyImg.src = "https://lh3.googleusercontent.com/d/1G_6Hv4Sju9qERe4HUariLE-GUv5oYc5z?key=123";
//                                 break;
//                             case 1:
//                                 trophyImg.src = "https://lh3.googleusercontent.com/d/1-1boSJcx9c9jY35_teEbT3KNts_8JnaD?key=123";
//                                 break;
//                             case 2:
//                                 trophyImg.src = "https://lh3.googleusercontent.com/d/1p1A9MtANQfk-qzRuyqneIx-2mWkf7KP4?key=123";
//                                 break;
//                         }
//                         trophyImg.className = 'w-14 mb-2';
                      
//                         const orderNumber = document.createElement('span');
//                         orderNumber.className = 'text-base font-bold text-gray-500';
//                         orderNumber.textContent = `อันดับ ${index + 1}`; // แสดงลำดับ

//                         userCard.appendChild(trophyImg);
//                         userCard.appendChild(userImg);
//                         userCard.appendChild(userName);
//                         userCard.appendChild(userScore);
//                         userCard.appendChild(orderNumber);
//                         topThreeContainer.appendChild(userCard);
//                         userCard.addEventListener('click', () => {
//                             openSwal(index + 1, user.ImageUrl, user.LineName, user.Nickname, user.Agent, user.Phone, user.LineID, user.Score);
//                         });
//                     });

//                     // สร้างและแสดงรายการผู้ใช้อื่นๆ
//                     otherUsers.forEach((user, index) => {
//                         const listItem = document.createElement('li');
//                         listItem.className = 'flex flex-col items-center profile-item';
//                         const userImg = document.createElement('img');
//                         userImg.src = user.ImageUrl;
//                         userImg.onerror = function() {
//                             this.src = "https://lh3.googleusercontent.com/d/1FgWIHOrgSbRUUrOd9yycwZZavgnco9D9?key=123";
//                         };
//                         userImg.alt = 'User Image';
//                         userImg.className = 'w-16 h-16 rounded-full object-cover mb-2';
//                         const userName = document.createElement('div');
//                         userName.textContent = user.Agent;
//                         userName.className = 'text-sm font-semibold';
//                         const userScore = document.createElement('div');
//                         userScore.textContent = `${user.Score} คะแนน`;
//                         userScore.className = 'text-xs';
                      
//                         const orderNumber = document.createElement('span');
//                         orderNumber.className = 'text-base font-bold text-gray-500';
//                         orderNumber.textContent = `อันดับ ${index + 4}`; // แสดงลำดับ

//                         listItem.appendChild(userImg);
//                         listItem.appendChild(userName);
//                         listItem.appendChild(userScore);
//                         listItem.appendChild(orderNumber);
//                         userList.appendChild(listItem);

//                         listItem.addEventListener('click', () => {
//                             // Swal.fire({
//                             //     title: "Are you sure?",
//                             //     text: "คุณต้องการดูรายละเอียด?",
//                             //     icon: "warning",
//                             //     showCancelButton: true,
//                             //     confirmButtonColor: "#3085d6",
//                             //     cancelButtonColor: "#d33",
//                             //     confirmButtonText: "ใช่! ฉันต้องการดู",
//                             //     cancelButtonText: "ไม่! ยกเลิก"
//                             // }).then((result) => {
//                             //     if (result.isConfirmed) {
//                                     openSwal(index + 4, user.ImageUrl, user.LineName, user.Nickname, user.Agent, user.Phone, user.LineID, user.Score); // ส่งข้อความเมื่อคลิกที่โปรไฟล์
//                             //     }
//                             // });

//                         });
//                     });
//                 })
//           .catch(error => console.error('Error fetching users:', error));
//       }
        // ฟังก์ชันสำหรับ preload ภาพและรับค่า URL ภาพที่ใช้ได้
async function getValidImageUrl(imgUrl) {
  try {
    await new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = resolve;
      img.onerror = reject;
      img.src = imgUrl;
    });
    return imgUrl; // ภาพโหลดสำเร็จ
  } catch (error) {
    return "https://lh3.googleusercontent.com/d/150vvdFqSOV1ex5yDGtwRs9mmnBIdFF5P?key=123"; // ภาพสำรอง
  }
}


async function openSwal(num, img, LineName, Nickname, Agent, Phone, LineID, Score) {
  const imageToDisplay = await getValidImageUrl(img);
         
    // ใช้ Swal.fire เพื่อแสดง Modal แทนการส่ง Flex Message
    Swal.fire({
    title: `<span style="font-size: 20px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 90%;">อันดับที่ ${num}: ${LineName}</span>`,
    html:
        `<div class="swal2-custom-image" style="border-radius: 20px; overflow: hidden; margin-bottom: 20px;"><img src="${imageToDisplay}" style="display: block; width: 100%;"></div>` +
        `<div class="swal2-custom-content" style="font-size: 16px; color: #444; text-align: left;">` +
        `<p style="margin-bottom: 0;"><b>ชื่อเล่น:</b> <span style="float: right; font-weight: normal;">${Nickname}</span></p>` +
        `<p style="margin-bottom: 0;"><b>รหัสตัวแทน:</b> <span style="float: right; font-weight: normal;">${Agent}</span></p>` +
        `<p style="margin-bottom: 0;"><b>เบอร์โทร:</b> <span style="float: right; font-weight: normal;">${Phone}</span></p>` +
        `<p style="margin-bottom: 0;"><b>ไอดีไลน์:</b> <span style="float: right; font-weight: normal;">${LineID}</span></p>` +
        `<p style="margin-bottom: 0;"><b>คะแนน:</b> <span style="float: right; font-weight: normal;">${Score}</span></p>` +
        `</div>`,
    width: '65%',
    showCloseButton: false,
    showCancelButton: true,
    confirmButtonText: 'คัดลอก LINE ID',
    cancelButtonText: 'แชร์',
    preConfirm: () => {
        navigator.clipboard.writeText(LineID).then(() => {
            Swal.fire('สำเร็จ!', 'คัดลอก LINE ID เรียบร้อย', 'success');
        });
    },
    customClass: {
        htmlContainer: 'swal2-custom-html',
        confirmButton: 'swal2-custom-confirm',
        cancelButton: 'swal2-custom-cancel'
    }
}).then((result) => {
    if (result.dismiss === Swal.DismissReason.cancel) {
        shareFlexMessage(num, img, LineName, Nickname, Agent, Phone, LineID, Score);
    }
});

}

       async function shareFlexMessage(num, img, LineName, Nickname, Agent, Phone, LineID, Score) {
  const imageToDisplay = await getValidImageUrl(img);
          
    const flexMessage = {
                                "type": "flex",
                                "altText": "ข้อมูลตัวแทน",
                                "contents":                               
{
  "type": "bubble",
  "hero": {
    "type": "image",
    "url":  "" + imageToDisplay,
    "size": "full",
    "aspectRatio": "20:13",
    "aspectMode": "cover",
  },
  "body": {
    "type": "box",
    "layout": "vertical",
    "contents": [
      {
        "type": "text",
        "text": "อันดับที่ " + num +" : " + LineName,
        "weight": "bold",
        "size": "xl",
        "align": "center"
      },
      {
        "type": "box",
        "layout": "vertical",
        "margin": "lg",
        "spacing": "sm",
        "contents": [
          {
            "type": "box",
            "layout": "horizontal",
            "spacing": "sm",
            "contents": [
              {
                "type": "text",
                "text": "ชื่อเล่น",
                "color": "#aaaaaa",
                "size": "sm",
                "flex": 1
              },
              {
                "type": "text",
                "text": "" + Nickname,
                "wrap": true,
                "color": "#666666",
                "size": "sm",
                "flex": 2
              }
            ]
          },
          {
            "type": "box",
            "layout": "horizontal",
            "spacing": "sm",
            "contents": [
              {
                "type": "text",
                "text": "รหัสตัวแทน",
                "color": "#aaaaaa",
                "size": "sm",
                "flex": 1
              },
              {
                "type": "text",
                "text": "" + Agent,
                "wrap": true,
                "color": "#666666",
                "size": "sm",
                "flex": 2
              }
            ]
          },
          {
            "type": "box",
            "layout": "horizontal",
            "spacing": "sm",
            "contents": [
              {
                "type": "text",
                "text": "เบอร์โทร",
                "color": "#aaaaaa",
                "size": "sm",
                "flex": 1
              },
              {
                "type": "text",
                "text": "" + Phone,
                "wrap": true,
                "color": "#666666",
                "size": "sm",
                "flex": 2
              }
            ]
          },
          {
            "type": "box",
            "layout": "horizontal",
            "spacing": "sm",
            "contents": [
              {
                "type": "text",
                "text": "ไอดีไลน์",
                "color": "#aaaaaa",
                "size": "sm",
                "flex": 1
              },
              {
                "type": "text",
                "text": "" + LineID,
                "wrap": true,
                "color": "#666666",
                "size": "sm",
                "flex": 2,
              }
            ]
          },
          {
            "type": "box",
            "layout": "horizontal",
            "spacing": "sm",
            "contents": [
              {
                "type": "text",
                "text": "คะแนน",
                "color": "#aaaaaa",
                "size": "sm",
                "flex": 1
              },
              {
                "type": "text",
                "text": "" + Score,
                "wrap": true,
                "color": "#666666",
                "size": "sm",
                "flex": 2,
              }
            ]
          }
        ]
      }
    ]
  },
  "footer": {
    "type": "box",
    "layout": "vertical",
    "spacing": "sm",
    "contents": [
      {
        "type": "button",
        "style": "primary",
        "height": "sm",
        "action": {
          "type": "clipboard",
          "label": "คัดลอก LINE ID",
          "clipboardText": "" + LineID
        }    
      },
      {
        "type": "button",
        "style": "primary",
        "height": "sm",
        "action": {
          "type": "uri",
          "label": "โทร",
          "uri": "tel:" + Phone
        },
        "color": "#aaf2bb"
      },
      {
        "type": "spacer",
        "size": "sm"
      }
    ],
    "flex": 0,
    "width": "80%",
    "offsetStart": "10%"
  }
                              
                            }
    };

    // ตรวจสอบว่าฟังก์ชัน shareTargetPicker สามารถใช้งานได้
    if (liff.isApiAvailable('shareTargetPicker')) {
        liff.shareTargetPicker([flexMessage])
        .then(() => {
            // ตรวจสอบว่าผู้ใช้เลือกหรือไม่
            if (liff.getOS() === 'android' && liff.getVersion() < '2.1.13') {
                // สำหรับ Android เวอร์ชันเก่า, ไม่สามารถตรวจสอบได้ว่าผู้ใช้ได้ทำการแชร์จริงหรือไม่
                Swal.fire('เสร็จสิ้น', 'กรุณาตรวจสอบการสนทนาของคุณ', 'success');
            } else {
                // สำหรับ iOS หรือ Android เวอร์ชันใหม่, จะได้รับการตอบกลับหากผู้ใช้ทำการแชร์
                Swal.fire('สำเร็จ!', 'ข้อมูลถูกแชร์ไปยังการสนทนาที่เลือก', 'success');
            }
        })
        .catch((err) => {
            console.error('Error sharing:', err);
            Swal.fire('ผิดพลาด', 'ไม่สามารถแชร์ข้อมูลได้', 'error');
        });
    } else {
        Swal.fire('ไม่สามารถใช้งาน', 'ฟีเจอร์แชร์ไม่สามารถใช้งานได้ในเวอร์ชันนี้ของ LINE', 'warning');
    }
} 
      
      // ฟังก์ชันเพื่อแสดง Modal
      function showModal() {
        document.getElementById('modal').classList.remove('hidden');
      }

      // ฟังก์ชันเพื่อซ่อน Modal
      function hideModal() {
        document.getElementById('modal').classList.add('hidden');
      }

    </script>
</body>

</html>
