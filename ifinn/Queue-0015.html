<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß : ‡πÑ‡∏≠‡∏ü‡∏¥‡∏ô‡∏ô‡πå [‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á]</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/versions/2.7.1/sdk.js"></script>

    <!-- Tailwind CSS for styling (optional) -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.1.2/dist/tailwind.min.css" rel="stylesheet">

<style>
    .status-pending {
        background-color: #48fa92; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô */
        width: 80px;
        text-align: center; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        padding: 2px 8px;
        border-radius: 12px;
        animation: blinker 1.5s infinite;
    }

    .status-transfer {
        background-color: #07daed; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
        width: 80px;
        text-align: center; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        padding: 2px 8px;
        border-radius: 12px;
    }

    .status-done {
        background-color: #28a745; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        width: 80px;
        text-align: center; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        padding: 2px 8px;
        border-radius: 12px;
    }

    .status-editing {
        background-color: #fa675c; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô */
        width: 80px;
        text-align: center; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        padding: 2px 8px;
        border-radius: 12px;
        animation: blinker 1.5s infinite;
    }
  
    .status-skip {
        background-color: #c07dfa; /* ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô */
        width: 80px;
        text-align: center; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        padding: 2px 8px;
        border-radius: 12px;
    }
  
    .status-available {
    background-color: #e2e8f0; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ */
    width: 80px;
    text-align: center; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
    padding: 2px 8px;
    border-radius: 12px;
    }

    @keyframes blinker {
        50% {
            opacity: 0.5;
        }
    }
</style>


  
</head>

<body>
    <div class="container mx-auto mt-10 p-4 bg-white rounded-lg shadow">
        <h1 class="text-center text-2xl font-bold mb-6">üí∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ôüí∞</h1>
        <h1 class="text-center text-3xl font-bold mb-6">‚ÄºÔ∏è‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‚ÄºÔ∏è</h1>
        <div class="grid grid-cols-5 gap-4" id="queueContainer">
            <!-- ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
        </div>
    </div>

    <script>
        liff.init({
            liffId: '1661371622-gyeVE5Ka'
        }).catch((err) => {
            console.error('LIFF Initialization failed: ', err);
        });
      
      function isBookingAllowed() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentDate = now.getDate(); // ‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (1-31)

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        if (currentDate < 1 || currentDate > 31) return false;
        //if (currentDate < 22 || currentDate > 25) return false;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
        if (currentHour === 8 && currentMinute < 30) return false;  // ‡∏Å‡πà‡∏≠‡∏ô 8:30‡∏ô.
        if (currentHour < 8) return false;  // ‡∏Å‡πà‡∏≠‡∏ô 8:00‡∏ô.
        if (currentHour > 23) return false;  // ‡∏´‡∏•‡∏±‡∏á 17:00‡∏ô.

        return true;
      }

        liff.ready.then(async () => {
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            const idToken = liff.getDecodedIDToken();
            const userId = idToken.sub;
            const displayName = idToken.name;
            const pictureUrl = idToken.picture;
            const email = idToken.email;

            $('form').append(`<input type="hidden" name="userId" value="${userId}">`);
            $('form').append(`<input type="hidden" name="displayName" value="${displayName}">`);
            $('form').append(`<input type="hidden" name="pictureUrl" value="${pictureUrl}">`);
            $('form').append(`<input type="hidden" name="email" value="${email}">`);

            let bookedData = {};
            await $.get('https://script.google.com/macros/s/AKfycbyEZoSG1eb57wG-mMVHhcaFfvqffGfFNOsWyUXYBTajoH29TjOLfITrgJ102gs0YNmG/exec', function(data) {
                bookedData = data;
            });

            const queueContainer = document.getElementById('queueContainer');
for (let i = 1; i <= 100; i++) {
    let formattedNumber = String(i);
    
    let queueWrapper = document.createElement('div');
    queueWrapper.className = "flex flex-col items-center mb-4";

    let queueElement = document.createElement('div');
    queueElement.className = "relative flex justify-center items-center bg-blue-500 text-white w-16 h-16 rounded-full cursor-pointer";
    queueWrapper.appendChild(queueElement);

    let statusElement = document.createElement('div');
statusElement.className = "text-sm mt-2 text-black";
    queueWrapper.appendChild(statusElement);

    if (bookedData[formattedNumber] && bookedData[formattedNumber].userId) {
    queueElement.innerHTML = `<img src="${bookedData[formattedNumber].pictureUrl}" class="queue-image w-16 h-16 rounded-full" alt="User Profile Picture"/>`;

    const statusFromSheet = bookedData[formattedNumber].G; // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ Assumption ‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå G ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤ "G"

    switch(statusFromSheet) {
    case "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£":
        statusElement.textContent = "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å...";
        statusElement.classList.add("status-pending");
        break;
    case "‡∏£‡∏≠‡πÇ‡∏≠‡∏ô":
        statusElement.textContent = "‡∏£‡∏≠‡πÇ‡∏≠‡∏ô";
        statusElement.classList.add("status-transfer");
        break;
    case "‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à":
        statusElement.textContent = "‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
        statusElement.classList.add("status-done");
        break;
    case "‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß":
        statusElement.textContent = "‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß";
        statusElement.classList.add("status-skip");
        break;
    case "‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•":
        statusElement.textContent = "‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...";
        statusElement.classList.add("status-editing");
        break;
    default:
        statusElement.textContent = "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß";
        statusElement.classList.add('status-available');
        break;
}

} else {
    queueElement.innerHTML = `<span class="queue-number text-2xl">${formattedNumber}</span><img class="queue-image w-20 h-20 rounded-full hidden" alt="User Profile Picture"/>`; 
    statusElement.textContent = "‡∏ß‡πà‡∏≤‡∏á";
    statusElement.classList.add('status-available');
}

                queueElement.dataset.queue = formattedNumber;
                queueElement.addEventListener('click', async function() {
                    if (!isBookingAllowed()) {
                      Swal.fire({
                            title: '‚ÄºÔ∏è‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‚ÄºÔ∏è',
                            html: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ<br>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 6-25 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>‡πÄ‡∏ß‡∏•‡∏≤ 08:30‡∏ô. - 17:00‡∏ô.',
                            //html: '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à<br>‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 22 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2566<br>‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á 08:30‡∏ô. - 17:00‡∏ô.',    
                            icon: 'warning'
                      });

                      return;
                    }
                    let numberElement = this.querySelector('.queue-number');
                    let imageElement = this.querySelector('.queue-image');

//                     if (imageElement.src && !imageElement.classList.contains('hidden')) {
//                         if (bookedData[formattedNumber] && bookedData[formattedNumber].userId === userId) {
//                             // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
//                             const cancelBookingData = {
//                                 action: 'cancel',
//                                 queueNumber: this.dataset.queue,
//                                 userId: "",
//                                 displayName: "",
//                                 pictureUrl: "",
//                                 email: "",
//                                 G: ""
//                             };

//                             $.post('https://script.google.com/macros/s/AKfycbyEZoSG1eb57wG-mMVHhcaFfvqffGfFNOsWyUXYBTajoH29TjOLfITrgJ102gs0YNmG/exec', cancelBookingData);

//                             Swal.fire('‚ö†Ô∏è‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‚ö†Ô∏è', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'info').then(() => {
//         liff.closeWindow();
//     });

//                             imageElement.classList.add('hidden');
//                         } else {
//                             Swal.fire('‚ÄºÔ∏è‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‚ÄºÔ∏è', '‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'warning');
//                         }
//                     } else
                  if (userAlreadyBooked(userId, bookedData)) {
                        Swal.fire('‚ÄºÔ∏è‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‚ÄºÔ∏è', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ', 'warning');
                        return;
                    } else {
    numberElement.classList.add('hidden');
    imageElement.src = pictureUrl;
    imageElement.classList.remove('hidden');

    const bookingData = {
        action: 'book',
        queueNumber: this.dataset.queue,
        userId: userId,
        displayName: displayName,
        pictureUrl: pictureUrl,
    };

    $.post('https://script.google.com/macros/s/AKfycbyEZoSG1eb57wG-mMVHhcaFfvqffGfFNOsWyUXYBTajoH29TjOLfITrgJ102gs0YNmG/exec', bookingData);

    Swal.fire('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => {
        liff.closeWindow();
    });
}
                });

                queueContainer.appendChild(queueWrapper);
            }
        });

        function userAlreadyBooked(userId, bookedData) {
            for (let queue in bookedData) {
                if (bookedData[queue].userId === userId) {
                    return true;
                }
            }
            return false;
        }

        function sendMsgLiff(msgTemplate) {
            if (liff.isInClient()) {
                liff.sendMessages([msgTemplate]).then(() => {
                    liff.closeWindow();
                }).catch((err) => {
       //             Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 'error');
                });
            } else {
                console.warn('This function is for sending messages from within the LINE app.');
            }
        }
    </script>
</body>

</html>
